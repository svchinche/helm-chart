apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "name" . }}-import-dump-script
  labels:
    app: {{ template "name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
data:
  setup.sh: |
    #!/bin/sh

    dump_location="/dump"
    echo "Checking dump availability"
    [[ ! -d $dump_location ]] && ( echo "Dump directory is not preset" ; exit 0 )  
    echo "Dump location found"

    echo "Finding out master node information"
    master_node=$(mongo --host {{ template "name" . }}.{{ .Release.Namespace }} --port 27017 --quiet --eval "db.isMaster()['"'primary'"']" | awk -F: '{ print $1}')
    
    echo "Importing mongo db dump"

    until mongorestore --host $master_node --port 27017 --db {{ .Values.global.env.secrets.DATABASE }} $dump_location/ccoms/
    do
      echo "Waiting for importing dump"
      sleep 2
    done
    
    echo "DB has been imported succesfully..."
